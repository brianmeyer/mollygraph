name: ci

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            "fastapi==0.115.*" \
            "uvicorn[standard]==0.32.*" \
            "mcp" \
            "neo4j==5.*" \
            "httpx==0.28.*" \
            "pydantic==2.*" \
            "python-dotenv==1.*" \
            "pyyaml==6.*" \
            "pytest==8.*"
          pip install -e "sdk[mcp]"

      - name: Validate SDK package + MCP entrypoint
        run: |
          python -c "from mollygraph_sdk import MollyGraphClient; print(MollyGraphClient.__name__)"
          mollygraph-mcp --help >/tmp/mollygraph-mcp-help.txt
          test -s /tmp/mollygraph-mcp-help.txt

      - name: Validate startup scripts
        run: |
          bash -n scripts/install.sh scripts/start.sh
          if HOME="$RUNNER_TEMP/home" MOLLYGRAPH_HOME_DIR="$RUNNER_TEMP/home/.graph-memory" ./scripts/start.sh >/tmp/mollygraph-start.out 2>&1; then
            echo "scripts/start.sh unexpectedly succeeded without install"
            cat /tmp/mollygraph-start.out
            exit 1
          fi
          grep -q "Run scripts/install.sh first." /tmp/mollygraph-start.out

      - name: Run smoke tests
        env:
          MOLLYGRAPH_TEST_MODE: "1"
        run: pytest -q -m smoke

  integration:
    runs-on: ubuntu-latest
    needs: smoke
    services:
      neo4j:
        image: neo4j:5
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_PLUGINS: '[]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            "fastapi==0.115.*" \
            "uvicorn[standard]==0.32.*" \
            "mcp" \
            "neo4j==5.*" \
            "httpx==0.28.*" \
            "pydantic==2.*" \
            "python-dotenv==1.*" \
            "pyyaml==6.*" \
            "pytest==8.*"
          pip install -e "sdk[mcp]"

      - name: Run integration tests
        env:
          MOLLYGRAPH_TEST_MODE: "1"
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: testpassword
        run: pytest -q -m integration
