# MollyGraph Service — Example Configuration
# Copy to .env (next to this file) and fill in your values.
# Variables that are commented out are optional; defaults are shown.

# ── Core server ────────────────────────────────────────────────────────────────
# HTTP host and port the service listens on.
GRAPH_MEMORY_HOST=127.0.0.1
GRAPH_MEMORY_PORT=7422

# Bearer token required by every API endpoint.
MOLLYGRAPH_API_KEY=dev-key-change-in-production

# Runtime profile: hybrid (default) | strict_ai | local
# MOLLYGRAPH_RUNTIME_PROFILE=hybrid

# Set to true to disable all external service calls (Neo4j, LLMs, etc.).
# Useful for unit tests and CI.
# MOLLYGRAPH_TEST_MODE=false

# ── Storage paths ──────────────────────────────────────────────────────────────
# Root data directory (all persistent files live here).
# Defaults to ~/.graph-memory
# MOLLYGRAPH_HOME_DIR=~/.graph-memory

# Individual path overrides (rarely needed — change MOLLYGRAPH_HOME_DIR instead).
# MOLLYGRAPH_QUEUE_DB=~/.graph-memory/extraction_queue.db
# MOLLYGRAPH_SQLITE_VEC_DB=~/.graph-memory/vectors.db
# MOLLYGRAPH_ZVEC_DIR=~/.graph-memory/zvec_collection

# ── Neo4j ─────────────────────────────────────────────────────────────────────
# Connection details for the Neo4j instance.
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=mollygraph

# ── API keys ───────────────────────────────────────────────────────────────────
# Set at least one provider key to enable LLM-backed audit / synonym enrichment.
# GOOGLE_API_KEY=
# ANTHROPIC_API_KEY=
# MOONSHOT_API_KEY=
# GROQ_API_KEY=
# OPENAI_API_KEY=
# OPENROUTER_API_KEY=
# TOGETHER_API_KEY=
# FIREWORKS_API_KEY=
# OLLAMA_API_KEY=      # not usually needed for local Ollama

# ── Embedding tiers ────────────────────────────────────────────────────────────
# First tier that succeeds wins; hash is always the final fallback (never fails).
#
# Tier order (comma-separated, tried left-to-right):
# MOLLYGRAPH_EMBEDDING_TIER_ORDER=sentence-transformers,ollama,cloud,hash
#
# sentence-transformers tier (primary default)
MOLLYGRAPH_EMBEDDING_ST_MODEL=jinaai/jina-embeddings-v5-text-nano
# MOLLYGRAPH_EMBEDDING_MODEL=          # generic fallback override (used if ST_MODEL is unset)
#
# ollama tier
# MOLLYGRAPH_EMBEDDING_OLLAMA_MODEL=nomic-embed-text
# OLLAMA_BASE_URL=http://127.0.0.1:11434
#
# cloud tier (requires OPENAI_API_KEY or equivalent)
# MOLLYGRAPH_EMBEDDING_CLOUD_PROVIDER=openai
# MOLLYGRAPH_EMBEDDING_CLOUD_MODEL=text-embedding-3-small
#
# Legacy single-backend override (skips tier chain entirely if set)
# MOLLYGRAPH_EMBEDDING_BACKEND=

# ── Vector store backend ───────────────────────────────────────────────────────
# zvec (default, zero-dependency), sqlite_vec, or auto
# MOLLYGRAPH_VECTOR_BACKEND=zvec

# ── Reranker (optional, off by default) ───────────────────────────────────────
# Cross-encoder reranking of merged graph+vector results.
# MOLLYGRAPH_RERANKER_ENABLED=false
# MOLLYGRAPH_RERANKER_MODEL=jinaai/jina-reranker-v2-base-multilingual

# ── Extractor ─────────────────────────────────────────────────────────────────
# NER/relation extraction backend.
# MOLLYGRAPH_EXTRACTOR_BACKEND=gliner2
# MOLLYGRAPH_EXTRACTOR_MODEL=               # entity model (default: GLINER_BASE_MODEL)
# MOLLYGRAPH_EXTRACTOR_RELATION_MODEL=Babelscape/rebel-large

# ── GLiNER self-improvement ────────────────────────────────────────────────────
# Base model for NER extraction and LoRA fine-tuning.
GLINER_BASE_MODEL=fastino/gliner2-large-v1

# Minimum labelled examples before LoRA is attempted.
# GLINER_FINETUNE_MIN_EXAMPLES=500
# Minimum examples before full fine-tune (no LoRA) is attempted.
# GLINER_FULL_FINETUNE_MIN_EXAMPLES=2000

# Cooldown between training runs.
# GLINER_FINETUNE_COOLDOWN_DAYS=7

# Benchmark delta threshold: new model must beat baseline by this amount.
# GLINER_FINETUNE_BENCHMARK_THRESHOLD=0.05

# LoRA plateau detection (early stopping).
# GLINER_LORA_PLATEAU_WINDOW=3
# GLINER_LORA_PLATEAU_EPSILON=0.01

# Training data scan limit per cycle.
# GLINER_TRAINING_SCAN_LIMIT=4000

# ── GLiREL relation enrichment (optional, off by default) ─────────────────────
# Second-pass relation extractor after GLiNER2.
# MOLLYGRAPH_GLIREL_ENABLED=false
# MOLLYGRAPH_GLIREL_MODEL=jackboyla/glirel-large-v0
# Minimum confidence to add/override GLiREL relations.
# MOLLYGRAPH_GLIREL_CONFIDENCE=0.5
# Minimum confidence to generate silver-label training examples from GLiREL.
# MOLLYGRAPH_GLIREL_TRAINING_THRESHOLD=0.8
# Enable LLM synonym enrichment for GLiREL labels (adds 3 phrasings via LLM).
# MOLLYGRAPH_GLIREL_LLM_SYNONYMS=true

# ── spaCy enrichment (optional, off by default) ────────────────────────────────
# Additive NER enrichment on top of GLiNER2 output.
# MOLLYGRAPH_SPACY_ENRICHMENT=false
# MOLLYGRAPH_SPACY_MODEL=en_core_web_sm
# MOLLYGRAPH_SPACY_MIN_GLINER_ENTITIES=2

# ── Relation soft gate (pre-write semantic validation) ────────────────────────
# Evaluates every relation candidate before graph upsert.
# Decisions: allow (write normally) | quarantine (write flagged) | skip (signal only).
# Never silently drops signals — skip and quarantine both emit suggestion events
# so the evolution / audit pipeline can learn from them.
#
# Enable/disable the gate:
# MOLLYGRAPH_RELATION_SOFT_GATE_ENABLED=true
#
# Plausibility score above which a relation is written normally:
# MOLLYGRAPH_RELATION_GATE_ALLOW_THRESHOLD=0.45
#
# Plausibility score above which a relation is quarantined (written but flagged).
# Below both thresholds → skip (but suggestion signal is always emitted).
# MOLLYGRAPH_RELATION_GATE_QUARANTINE_THRESHOLD=0.25
#
# Extractor confidence that overrides a "skip" to "quarantine".
# Ensures very confident but unusual triples reach audit instead of being lost.
# MOLLYGRAPH_RELATION_GATE_HIGH_CONF_OVERRIDE=0.85
#
# contacts_json source priors (handled automatically inside the gate):
#   Boosted rels (+30%): CONTACT_OF, WORKS_AT, LOCATED_IN, MEMBER_OF, CLASSMATE_OF
#   Down-weighted rels (×0.55): CHILD_OF, PARENT_OF, REPORTS_TO, MENTORED_BY, MENTORS

# ── Relation schema extension (optional) ──────────────────────────────────────
# Path to a YAML file with additional relation types to merge into the default schema.
# RELATION_SCHEMA_FILE=

# ── Schema auto-adoption ───────────────────────────────────────────────────────
# Maximum new relation/entity types adopted per nightly cycle.
# MOLLYGRAPH_SCHEMA_ADOPTION_LIMIT=3

# ── Audit / Maintenance ────────────────────────────────────────────────────────
# Set to 1 (or true) to enable LLM-backed relationship audit.
# AUDIT_LLM_ENABLED=0

# Audit provider tier chain (deterministic always runs first; LLM tiers fall through):
# MOLLYGRAPH_AUDIT_PROVIDER_TIERS=deterministic,local,primary,fallback

# local tier — e.g. Ollama, no API key required
# MOLLYGRAPH_AUDIT_TIER_LOCAL=ollama
# MOLLYGRAPH_AUDIT_MODEL_LOCAL=llama3.1:8b
# OLLAMA_CHAT_BASE_URL=http://127.0.0.1:11434/v1

# primary tier — cloud LLM tried after local fails
MOLLYGRAPH_AUDIT_TIER_PRIMARY=moonshot
MOLLYGRAPH_AUDIT_MODEL_PRIMARY=kimi-k2.5

# fallback tier — different provider tried if primary also fails
# MOLLYGRAPH_AUDIT_TIER_FALLBACK=groq
# MOLLYGRAPH_AUDIT_MODEL_FALLBACK=llama-3.3-70b-versatile

# Legacy per-schedule model overrides (still honoured when per-tier model is unset)
# AUDIT_MODEL_NIGHTLY=llama3.1:8b
# AUDIT_MODEL_WEEKLY=llama3.1:8b
# AUDIT_MODEL_PRETRAIN=llama3.1:8b

# Legacy single-provider override (maps to primary tier when AUDIT_TIER_PRIMARY is unset)
# AUDIT_PROVIDER_ORDER=none

# Auto-delete entities flagged by nightly audit (use with care).
# MOLLYGRAPH_AUDIT_AUTO_DELETE=false
# Maximum entities auto-deleted per audit run (absolute cap).
# MOLLYGRAPH_AUDIT_AUTO_DELETE_MAX=15
# Cap as a percentage of relationships reviewed.
# MOLLYGRAPH_AUDIT_AUTO_DELETE_PCT=5

# ── Audit auto-delete limits ───────────────────────────────────────────────────
# Minimum entities auto-deleted per audit run (floor).
# MOLLYGRAPH_AUDIT_AUTO_DELETE_MIN=3

# ── Schema drift alarm thresholds ─────────────────────────────────────────────
# Alert when relationship or entity type count grows by more than N%.
# config.py reads MOLLYGRAPH_DRIFT_ALARM_REL and MOLLYGRAPH_DRIFT_ALARM_ENT.
# MOLLYGRAPH_DRIFT_ALARM_REL=25
# MOLLYGRAPH_DRIFT_ALARM_ENT=25

# ── Degradation detection ─────────────────────────────────────────────────────
# Rolling window (seconds) for degradation rate tracking.
# MOLLYGRAPH_DEGRADATION_WINDOW=300
# Error fraction that triggers the degraded alarm.
# MOLLYGRAPH_DEGRADATION_THRESHOLD=0.5

# ── Strict AI mode ─────────────────────────────────────────────────────────────
# When true, all entity/relation ingest is blocked unless an LLM extractor is active.
# MOLLYGRAPH_STRICT_AI=false

# ── Maintenance lock timeout ───────────────────────────────────────────────────
# How long (seconds) a maintenance lock is held before it auto-expires.
# MOLLYGRAPH_LOCK_TIMEOUT=3600

# ── Schema adoption limits ─────────────────────────────────────────────────────
# Cap on new relation types auto-adopted per nightly run.
# MOLLYGRAPH_MAX_NEW_RELATIONS=5
# Cap on new entity types auto-adopted per nightly run.
# MOLLYGRAPH_MAX_NEW_ENTITIES=5

# ── Graph-aware reranker ───────────────────────────────────────────────────────
# Re-scores query results using graph signals (neighbor count, path distance,
# relationship type relevance). Independent of the cross-encoder reranker.
# MOLLYGRAPH_GRAPH_RERANK_ENABLED=false

# Graph rerank scoring weights (tune to balance graph signal vs. vector score):
# MOLLYGRAPH_RERANK_ENABLED=false         # legacy global rerank switch
# MOLLYGRAPH_RERANK_NEIGHBOR_WEIGHT=0.15  # weight for 1-hop neighbor count
# MOLLYGRAPH_RERANK_STRENGTH_WEIGHT=0.10  # weight for avg relationship strength
# MOLLYGRAPH_RERANK_PATH_BONUS=0.05       # per-hop path bonus to query entities

# ── LoRA training ──────────────────────────────────────────────────────────────
# Cooldown between LoRA runs (separate from full fine-tune cooldown).
# GLINER_LORA_COOLDOWN_DAYS=3

# Minimum new training examples required since last run before training starts.
# GLINER_MIN_NEW_EXAMPLES=50

# Maximum training examples kept in the sliding window (older are dropped from memory).
# GLINER_MAX_TRAINING_EXAMPLES=5000

# Archive training .jsonl files older than this many days.
# GLINER_ARCHIVE_DAYS=30

# Enable shadow model comparison: runs both base and fine-tuned on each ingest.
# GLINER_SHADOW_ENABLED=false
# Number of recent episodes to use for shadow evaluation.
# GLINER_SHADOW_EPISODES=20

# Benchmark tolerance for LoRA promotion (how much worse is still acceptable).
# MOLLYGRAPH_LORA_BENCHMARK_TOLERANCE=0.02

# ── Ollama embedding model (shorthand) ────────────────────────────────────────
# Alias for MOLLYGRAPH_EMBEDDING_OLLAMA_MODEL used in some contexts.
# MOLLYGRAPH_OLLAMA_EMBED_MODEL=nomic-embed-text

# ── Provider base URLs (override defaults) ────────────────────────────────────
# OLLAMA_BASE_URL=http://127.0.0.1:11434
# OLLAMA_CHAT_BASE_URL=http://127.0.0.1:11434/v1
# MOONSHOT_BASE_URL=https://api.moonshot.ai/v1
# GROQ_BASE_URL=https://api.groq.com/openai/v1
# OPENAI_BASE_URL=https://api.openai.com/v1
# OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
# TOGETHER_BASE_URL=https://api.together.xyz/v1
# FIREWORKS_BASE_URL=https://api.fireworks.ai/inference/v1

# --- Infra health evaluator (deterministic-first) ---
MOLLYGRAPH_INFRA_MIN_INDEX_COMPLETENESS_OPTIMIZE=0.995
MOLLYGRAPH_INFRA_MIN_INDEX_COMPLETENESS_REINDEX=0.97
MOLLYGRAPH_INFRA_MAX_ENTITY_COVERAGE_DRIFT_PCT_REINDEX=0.15
MOLLYGRAPH_INFRA_MAX_ENTITY_COVERAGE_DRIFT_PCT_REBUILD=0.35
MOLLYGRAPH_INFRA_SIM_ERROR_RATE_REINDEX=0.15
MOLLYGRAPH_INFRA_SIM_ERROR_RATE_REBUILD=0.40
MOLLYGRAPH_INFRA_SIM_LATENCY_MS_OPTIMIZE=250
MOLLYGRAPH_INFRA_SIM_LATENCY_MS_REINDEX=600
MOLLYGRAPH_INFRA_QUEUE_BACKLOG_WARN=500
MOLLYGRAPH_INFRA_LLM_ADVISORY=0
